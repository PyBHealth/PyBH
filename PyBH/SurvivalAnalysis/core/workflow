import pandas as pd
import numpy as np
import arviz as az
from typing import Optional
from SurvivalAnalysis.core.interface import SurvivalModelBuilder

class BayesianSurvivalWorkflow:
    """
    Workflow Manager.
    
    This class orchestrates the analysis process:
    1. Input Validation
    2. Data Preprocessing
    3. Model Building (via the injected Builder)
    4. MCMC Sampling
    5. Diagnostics & Plotting
    """

    def validate_inputs(self, data: pd.DataFrame, time_col: str, event_col: str):
        """
        Validates data integrity before processing.
        
        """
        # 1. Check if DataFrame is empty
        if data.empty:
            raise ValueError("The input dataset is empty.")

        # 2. Check column existence
        if time_col not in data.columns or event_col not in data.columns:
            raise ValueError(f"Columns '{time_col}' or '{event_col}' not found in dataset.")

        # 3. Type Validation (Numeric or Date)
        is_numeric = np.issubdtype(data[time_col].dtype, np.number)
        is_datetime = pd.api.types.is_datetime64_any_dtype(data[time_col])

        if not is_numeric and not is_datetime:
            raise TypeError(f"Column '{time_col}' must be numeric or datetime format.")
            
        # 4. Check if there is at least one event (otherwise survival analysis is useless)
        if data[event_col].sum() == 0:
            print("Warning: No events observed in the dataset. Convergence might fail.")


    def _preprocess_data(self, data: pd.DataFrame, time_col: str, event_col: str) -> pd.DataFrame:
        """
        Cleans data (handles missing values).
        """
        df = data.copy()
        
        # Basic strategy: drop rows with missing values in key columns
        df = df.dropna(subset=[time_col, event_col])
        
        return df


    def check_diagnostics(self) -> None:
        """
        Checks convergence metrics using ArviZ.
        """
        if self.idata is None:
            raise RuntimeError("Model has not been trained. Run .fit() first.")

        # Logic to check R-hat would go here
        print("Checking convergence statistics...")

    def plot_survival_function(self, **kwargs):
        """
        Generates the survival curve with credible intervals.
        """
        if self.idata is None:
            raise RuntimeError("Model has not been trained. Run .fit() first.")
        
        print(f"Plotting survival curve for {self.builder.name}...")
        # Plotting logic using Matplotlib/ArviZ would go here